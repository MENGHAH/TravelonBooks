# 主键和聚簇/非聚簇索引

[一分钟明白MySQL聚簇索引和非聚簇索引](https://www.cnblogs.com/sy270321/p/12864357.html)

[Mysql-如何正确的使用索引以及索引的原理 ](https://www.cnblogs.com/ManyQian/p/9076247.html)

> - 聚簇索引：将存储的数据和索引放到了一块，找到索引也就找到了数据。
> - 非聚簇索引：将存储的数据存储和索引分开，索引结构的叶子节点指向了数据的对应行，myisam通过key_buffer把索引先缓存到内存中，当需要访问数据时（通过索引访问数据），在内存中直接搜索索引，然后通过索引找到磁盘相应数据，这也就是为什么索引不在key buffer命中时，速度慢的原因。

>  **澄清一个概念**：innodb中，在聚簇索引之上创建的索引称之为辅助索引，辅助索引访问数据总是需要二次查找，非聚簇索引都是辅助索引，像复合索引、前缀索引、唯一索引，辅助索引叶子节点存储的不再是行的物理位置，而是主键值。

**聚簇索引和非聚簇索引：**聚簇索引和非聚簇索引表示的是一种数据存储的结构。和唯一索引、联合索引等有着概念上的区别。**唯一索引、联合索引**等都叫做辅助索引，也可以称为非聚簇索引，因为通过这些索引只能在叶节点找到主键值和当前索引列的值。如果要想获取当前主键值对应行中的其他数据，还要通过主键进行一次**回表**来获取数据。

**主键索引**是比较特殊的索引，如果通过主键索引进行数据查找，那么在叶节点可以获取当前主键对应行的所有数据， 不再需要回表。

**举例说明：**

```sql
create table student (
    id bigint,
    no varchar(20) ,
    name varchar(20) ,
    address varchar(20) ,
    PRIMARY KEY (`branch_id`) USING BTREE,
    UNIQUE KEY `idx_no` (`no`) USING BTREE
)ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC;
```

第一种，直接根据主键查询获去所有字段数据，此时主键是聚簇索引，因为主键对应的索引叶子节点存储了id=1的所有字段的值。

```sql
select * from student where id = 1
```

第二种，根据编号查询编号和名称，编号本身是一个唯一索引，但查询的列包含了学生编号和学生名称，当命中编号索引时，该索引的节点的数据存储的是主键ID，需要根据主键ID重新查询一次，所以这种查询下no不是聚簇索引

```sql
select no,name from student where no = 'test'
```

第三种，我们根据编号查询编号（有人会问知道编号了还要查询？要，你可能需要验证该编号在数据库中是否存在），这种查询命中编号索引时，直接返回编号，因为所需要的数据就是该索引，不需要回表查询，这种场景下no是聚簇索引

```sql
select no from student where no = 'test'
```

# 最左匹配原则

**最左匹配原则：**所谓最左原则指的就是如果你的 SQL 语句中用到了联合索引中的最左边的索引，那么这条 SQL 语句就可以利用这个联合索引去进行匹配，值得注意的是，**当遇到范围查询(>、<、between、like)就会停止匹配。**

![img](https://images2018.cnblogs.com/blog/1036857/201711/1036857-20171126004856453-1491949427.png)

从上图看，当按照联合索引进行数据存储的时候，首先按照最左侧字段顺序进行存储，当最左侧值相同时，再按照第二个字段值的顺序存储。因此， 第一个字段是有序的（1,1,2,2,3,3），但是第二个字段并非有序的。

当b+树的数据项是复合的数据结构，比如(name,age,sex)的时候，b+数是按照从左到右的顺序来建立搜索树的，比如当(张三,20,F)这样的数据来检索的时候，b+树会优先比较name来确定下一步的所搜方向，如果name相同再依次比较age和sex，最后得到检索的数据；但当(20,F)这样的没有name的数据来的时候，b+树就不知道下一步该查哪个节点，因为建立搜索树的时候name就是第一个比较因子，必须要先根据name来搜索才能知道下一步去哪里查询。比如当(张三,F)这样的数据来检索时，b+树可以用name来指定搜索方向，但下一个字段age的缺失，所以只能把名字等于张三的数据都找到，然后再匹配性别是F的数据了， 这个是非常重要的性质，即索引的最左匹配特性。

# MySQL日志

[简单聊聊MySQL中的六种日志](https://juejin.cn/post/7077577452372885535)

MySQL中存在着以下几种日志：重写日志（redo log）、回滚日志（undo log）、二进制日志（bin log）、错误日志（error log）、慢查询日志（slow query log）、一般查询日志（general log）。
