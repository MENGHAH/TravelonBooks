

# 1. RTP传输层

## 1.1 JitterBuffer

**(1) 概念**

jitterBuffer工作在接收端，主要针对网络抖动造成的音视频卡顿而设计。WebRTC中的Jitter Buffer是一个用于处理网络抖动（jitter）的缓冲区，它的作用是为音频或视频数据提供一个平滑的播放体验。当我们在网络上传输音频或视频数据时，由于网络传输延迟和不可预测的网络抖动，数据包很可能会以不同的速度到达接收端。这可能会导致数据包在接收端的播放速度不一致，从而影响音频或视频的质量和连续性。Jitter Buffer的原理是将接收到的数据包缓存到一个缓冲区中，在缓冲区中等待一段时间，以便其他数据包到达。然后，Jitter Buffer会按照正确的顺序将数据包发送到音频或视频播放器，以确保数据包按照正确的速率播放。

**(2) 工作原理**

- 接收侧收到数据包，开始组帧，这一步是必须的，帧不完整会导致花屏。

- 每个帧组好之后，放进buffer里，然后按照帧序号进行排序。
- 检查帧的参考关系。对于解码器来说，如果一个帧的参考帧丢失了，那么这个帧将解码失败或者花屏，所以参考关系必须要满足之后才能把数据送进解码器里。
- 根据每一帧的时间戳（采集时间戳或者发送时间戳）以及接收时间戳计算抖动。这里的难点在于如何精确计算抖动。
- 根据抖动计算buffer的长度。
- 根据抖动自适应的调整buffer长度。抖动越大，预留的buffer长度越大，这样可以利用增加延迟的方式来降低卡顿；抖动越小，预留的buffer长度越小，这样可以降低延迟。

## 1.2 RTCP

- 音频可以借助RTCP实现NACK+重传
- 音频的opus编码可以借助RTCP实现FEC，opus编码也支持PLC
- 视频有专门的FEC（前向纠错）或PLC（丢包隐藏）

# 2. 编码层

## 2.1 音频

### 2.1.1 OPUS编码

opus编码可以借助RTCP实现FEC。在WebRTC中的实现如下：



## 2.2 视频

### 2.2.1 长参考帧



# 3. 带后处理

音频的带外plc，视频带外fec



# 其他

- rtp这层：jitter
- rtcp这层：rtcp feedback。nack（音视频通用）视频有专门的PLI、FIR
- 编码这层：带内容错手段，比如opus支持带内fec、plc，264的长参考帧、短参考帧
- 带外后处理：音频的带外plc，视频带外fec



# 专业名词

###  前向纠错（FEC）

它的基本原理是在发送数据之前，对数据进行冗余编码，使得数据在传输过程中即使出现了错误，也能够通过冗余信息进行错误检测和纠正，从而保证数据的完整性和准确性。

FEC（前向纠错）机制的原理是在数据传输过程中，通过在发送端添加冗余数据（即纠错码）来检测和纠正可能发生的传输错误。以下是FEC机制原理的详细解释：

1. 编码：在发送端，原始数据首先被分为多个小块（也称为数据包）。然后，根据特定的编码规则（如循环冗余校验（CRC）、里德-所罗门码（Reed-Solomon codes）、汉明码（Hamming codes）等），将这些小块与冗余数据（纠错码）结合，生成一个包含原始数据和纠错码的数据包。这个数据包随后被发送到接收端。
2. 传输：编码后的数据包通过网络或通信信道发送到接收端。在传输过程中，可能会由于各种原因（如网络拥塞、干扰、噪声等）导致数据包中的某些位发生变化，从而产生错误。
3. 解码与纠错：在接收端，接收到的数据包首先经过解码过程。解码器使用与发送端相同的纠错码算法来分析接收到的数据包。如果检测到错误，解码器会尝试使用冗余数据（即纠错码）来纠正这些错误，恢复出原始数据。具体来说，解码器会分析数据包中的纠错码，确定错误的位置和类型，然后使用纠错码来修正这些错误。如果错误超出了纠错能力范围，则可能无法完全恢复数据。

通过这种方式，FEC机制可以在数据传输过程中检测和纠正错误，从而提高数据传输的可靠性和稳定性。它不需要在检测到错误后重新发送数据，而是可以在接收端直接纠正错误，从而减少了传输延迟和带宽占用。

### 数据包丢失隐藏技术（PLC）

数据包丢失隐藏技术（Packet Loss Concealment，PLC）是一种在通信过程中，特别是在实时语音或视频传输中，当遇到数据包丢失时用于隐藏或补偿丢失数据的技术。

在实时语音通信中，如果在接收端存在无法通过前向纠错等算法恢复的丢失帧，就需要对语音信息进行处理。丢包隐藏技术通常利用听觉感知模型中的人耳的听觉掩蔽效应，对丢失的语音波形进行补偿，使得人耳听起来感觉没有很大的影响。

具体来说，丢包隐藏技术可以通过以下方式实现：

1. **零插入**：当检测到数据包丢失时，将丢失的语音帧替换为零，即静音处理。
2. **波形替代**：通过重复已经接收到的语音的一部分来重建丢失的语音帧。
3. **参数插值**：对于基于参数的语音编码，可以利用已接收到的语音帧的参数来插值或预测丢失帧的参数。

丢包隐藏技术并不真正恢复丢失的数据，而是通过模拟或预测来弥补丢帧带来的影响。因此，它通常适用于丢包率不高的情况，如经过其他丢包恢复技术处理后剩下的少量无法恢复的包。

在实时通信中，丢包隐藏技术对于保持音频和视频流的连续性和可听性至关重要。特别是在无线信道等恶劣的传输环境下，丢包隐藏技术能够显著提高通信质量。

### NACK

NACK是“Negative ACKnowledgment”的缩写，中文意思是**否定确认**。在网络通信中，NACK是一种重要的机制，用于处理数据包丢失的问题。

具体来说，当接收端检测到数据丢包时，它会发送NACK报文到发送端。NACK报文中包含了丢失数据包的序列号，发送端根据这个序列号在发送缓冲区中找到对应的数据包，并将其重新发送到接收端。这种机制能够有效地抵抗网络错误，保证数据传输的完整性和可靠性。

在RFC 4585协议中，定义了两种类型的NACK：RTPFB和PLI。RTPFB是RTP报文丢失重传的NACK，而PLI则是视频帧丢失重传的NACK。以WebRTC为例，它会协商使用这两种类型的NACK来确保数据传输的可靠性。

以上是关于NACK的基本介绍，希望能对您有所帮助。

### 自动重传请求（ARQ）

**ARQ（Automatic Repeat-reQuest，自动重传请求）** 是一种数据通信中常用的错误控制技术，用于在数据传输过程中检测并纠正错误，确保数据的准确传输。其主要工作原理涉及发送方发送数据包，接收方收到数据包后进行确认或请求重传，并在一定条件下实现数据的可靠传输。

在音视频传输中，ARQ的作用在于解决数据传输过程中可能出现的错误，确保音视频数据的可靠性和完整性。以下是如何在音视频传输中使用ARQ的基本步骤：

1. **数据包编号**：在发送音视频数据时，每个数据包都会被分配一个唯一的序列号。这有助于接收端识别丢失或错误的数据包，并准确地请求重新发送。
2. **错误检测**：接收端使用某种错误检测机制（如CRC校验）来检查接收到的数据包是否完整且没有错误。如果检测到错误，接收端会丢弃该数据包，并准备发送NACK（否定确认）消息给发送端。
3. **发送NACK**：当接收端检测到数据包错误或丢失时，它会发送NACK消息给发送端，消息中包含丢失或错误数据包的序列号。
4. **重传数据包**：发送端在接收到NACK消息后，会重新发送对应序列号的数据包。这个过程可能会根据网络条件和具体的ARQ策略进行多次。
5. **重传策略**：发送端在决定如何重传数据包时，可能会使用多种策略，如停止-等待ARQ、连续ARQ或选择性重传ARQ等。这些策略根据具体的网络条件和需求来选择，以优化数据传输的效率和可靠性。

需要注意的是，虽然ARQ可以确保数据的可靠传输，但它也可能导致延迟增加。在实时音视频传输中，延迟是一个非常重要的因素。因此，在使用ARQ时，需要根据具体的应用场景和网络条件来权衡可靠性和延迟之间的关系。

此外，为了提高音视频传输的效率和可靠性，还可以结合使用其他技术，如FEC（前向纠错）技术。FEC技术可以在一定程度上预测和纠正数据中的错误，从而减少对ARQ机制的依赖，降低延迟并提高传输效率。



