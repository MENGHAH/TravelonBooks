# 参考文章

[H.264视频流的传输与载荷——将H264码流打包成RTP包](https://www.cnblogs.com/stnlcd/p/7266797.html)

[RTP中H264封装NALU格式详细解析](https://blog.csdn.net/weixin_45312249/article/details/122512390)

# 1. H264基础概念

## 1.1 NAL、slice与frame意思及相互关系

1 frame的数据可以分为多个slice。每个slice中的数据，在帧内预测只用到自己slice的数据， 与其他slice 数据没有依赖关系。NAL 是用来将编码的数据进行打包的。 比如，每一个slice 数据可以放在NAL 包中。

- I frame 是自己独立编码，不依赖于其他frame 数据
- P frame 依赖 I frame 数据
- B frame 依赖 I frame, P frame 或其他 B frame 数据

一个frame是可以分割成多个slice来编码的，而一个slice编码之后被打包进一个NAL单元，不过NAL单元除了容纳slice编码的码流外，还可以容纳其他数据，比如序列参数集SPS。

NAL指网络提取层，里面放一些与网络相关的信息。slice是片的意思，H.264中把图像分成一帧（frame）或两场（field），而帧又可以分成一个或几个片（Slilce）；片由宏块（MB）组成。宏块是编码处理的基本单元。

## 1.2 NAL nal_unit_type和编码模式

- NAL nal_unit_type中的1（非IDR图像的编码条带）、2（编码条带数据分割块A）、3（编码条带数据分割块B）、4（编码条带数据分割块C）、5（IDR图像的编码条带），此5种类型代表接下来数据是表示啥信息的和具体如何分块。
- lice种的三种编码模式I_slice、P_slice、B_slice 表示I类型的片、P类型的片，B类型的片。其中I_slice为帧内预测模式编码；P_slice为单向预测编码或帧内模式；B_slice 中为双向预测或帧内模式。

## 1.3 I、P 、B 之间有什么映射关系
I frame、P frame、 B frame关系同 I_slice、P_slice、B_slice，slice和frame区别在问题1中已经讲明白。

## 1.4 NAL nal_unit_type中的6、7、8

最后，NAL nal_unit_type中的6（SEI）、7（SPS）、8（PPS）属于什么帧呢？NAL nal_unit_type 为序列参数集（SPS）、图像参数集（PPS）、增强信息（SEI）不属于啥帧的概念。表示后面的数据信息为序列参数（SPS）、图像参数集（PPS）、增强信息（SEI）。

# 2. NALU格式详细解析

NAL的英文全称为Network Abstract Layer，即网络抽象层，在H264/AVC视频编解码标准中，整个系统框架分为两个层面，视频编解码层面(VCL)和网络抽象层面(NAL)。<font color=red>**VCL负责有效表示视频数据内容，NAL负责格式化数据并加上相应的头信息**，以保证数据适合各种信道和存储介质上的传输</font>。NAL单元**NALU是NAL的基本语法结构**，它包含一个字节的头信息和一系列来自VCL的原始字节载序列载荷(RBSP)的字节流。

NAL单元（NALU）组成由**起始码、NAL头、NAL Payload**三部分组成。

![在这里插入图片描述](https://img-blog.csdnimg.cn/d564c911f6544f7ebfad26a44ad54b17.png?)

- 起始码：分为3或者4字节的0x000001和0x00000001两种的开始码

- NAL头： 长度为1字节

  ![在这里插入图片描述](https://img-blog.csdnimg.cn/02b2497ee01447b8a1baf170bed4f3c3.png?)

  ![在这里插入图片描述](https://img-blog.csdnimg.cn/bda18c205f2f4f61b8dd25ff4c1de1d0.png?)

- NAL Payload：具体的NAL内容payload

一个简单的例子：
NALU头为0x67,转换为二进制0110 0111
禁止位为0
NAL重要性为11，即3，表示最重要
NALU类型为[00111],即7，类型为7表示该NALU是SPS

# 3. RTP封包格式

一共有三种模式：**单一NALU模式、组合封包模式、分片封包模式**

## 3.1 单一NALU模式

![在这里插入图片描述](https://img-blog.csdnimg.cn/9b823037351742359bbe87ee9096aa46.png?)

单一nalu模式是指将将单个nalu数据去除起始码后添加RTP包头进行封装。因受限于MTU最大允许为1500字节，因此这种模式要求nalu的有效数据载荷比较小，添加RTP包头后不可大于1500字节。否则一个RTP包就无法填充完整的一个nalu载荷，这时候就需要对nalu进行分包处理。

## 3.2 组合封包模式

> 1. 组合封包模式中是如何知道在底层数据结构划分不同nalu的呢？
> 2. 针对不同时间戳的nalu应该如何进行组合封包呢？

![在这里插入图片描述](https://img-blog.csdnimg.cn/512e1732c30a4474b035692138275d66.png?)

当单个nalu数据量非常小时，需要考虑将多个nalu聚合以封装成RTP包并发送，也就是组合封包模式。组合封包既可以对相同时间戳的nalu进行聚合，也可以对不同时间戳的nalu聚合，只是封包的包头有所区别。针对不同组合封包，对应头部Type字段值如下：

- 24  STAP-A  单一时间的组合包
-  25  STAP-B  单一时间的组合包
-  26  MTAP16  多个时间的组合包
-  27  MTAP24  多个时间的组合包

### 3.2.1 单时间聚合-STAP

STAP-A 用于非交错模式。STAP-用于交错模式，它们结构上最大的区别是是否需要携带 DON，每个 NALU 都会有长度标识。DON 和 NALU Size 都是无符号整数，网络字节序形式。如下是两种包的 RTP 封装格式示意图。：

```Shell
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RTP Header                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|STAP-A NAL HDR |         NALU 1 Size           | NALU 1 HDR    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         NALU 1 Data                           |
:                                                               :
+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               | NALU 2 Size                   | NALU 2 HDR    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         NALU 2 Data                           |
:                                                               :
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Figure 7.  An example of an RTP packet including an STAP-A
           containing two single-time aggregation units

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RTP Header                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|STAP-B NAL HDR | DON                           | NALU 1 Size   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| NALU 1 Size   | NALU 1 HDR    | NALU 1 Data                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
:                                                               :
+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               | NALU 2 Size                   | NALU 2 HDR    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       NALU 2 Data                             |
:                                                               :
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Figure 8.  An example of an RTP packet including an STAP-B
           containing two single-time aggregation units
```

### 3.2.2 多时间聚合-MULT

MTAP 聚合包与STAP比起来，差别最大的在头部。因为可能聚合多个不同时间的包，所以必须携带一个基准的 DON, timestamp。DOND 和 TS offset 是与基准的差值，这个基准应该是取自时间最早的那个 NALU 的值。DONB 和 NALU Size 为 16 位无符号整数，DOND 为 8 位无符号整数，TS offset 为 16 或者 24 位 无符号整数，均为网络字节序形式。

MTAP16 和 MTAP24 在本质上并没有什么差别，只是用了更多的位数来表达时间差，如果这个位数越多，可以容纳的时间戳差值越大，也就代表 MTAP 具有更大的扩展性，但是也占用了更多的头部字节，还是需要综合考虑性价比。

```shell
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RTP Header                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|MTAP16 NAL HDR |  decoding order number base   | NALU 1 Size   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  NALU 1 Size  |  NALU 1 DOND  |       NALU 1 TS offset        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  NALU 1 HDR   |  NALU 1 DATA                                  |
+-+-+-+-+-+-+-+-+                                               +
:                                                               :
+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               | NALU 2 SIZE                   |  NALU 2 DOND  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       NALU 2 TS offset        |  NALU 2 HDR   |  NALU 2 DATA  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               |
:                                                               :
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
Figure 12.  An RTP packet including a multi-time aggregation
            packet of type MTAP16 containing two multi-time
            aggregation units


 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RTP Header                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|MTAP24 NAL HDR |  decoding order number base   | NALU 1 Size   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  NALU 1 Size  |  NALU 1 DOND  |       NALU 1 TS offs          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|NALU 1 TS offs |  NALU 1 HDR   |  NALU 1 DATA                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
:                                                               :
+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               | NALU 2 SIZE                   |  NALU 2 DOND  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       NALU 2 TS offset                        |  NALU 2 HDR   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  NALU 2 DATA                                                  |
:                                                               :
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
Figure 13.  An RTP packet including a multi-time aggregation
            packet of type MTAP24 containing two multi-time
            aggregation units

```



## 3.3 分片封包

> 如何标定一个分片是起始、中间或者结束帧？

而当 NALU 的长度超过 MTU（1500字节） 时, 就必须对 NALU 单元进行分片封包. 也称为 Fragmentation Units (FUs).

```Shell
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| FU indicator  |   FU header   |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
|                                                               |
|                         FU payload                            |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           Figure 14.  RTP payload format for FU-A

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| FU indicator  |   FU header   |               DON             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-|
|                                                               |
|                         FU payload                            |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
           Figure 15.  RTP payload format for FU-B
```

同样分为两种格式 FU-A 和 FU-B，结构差别只在于一个 DON，相同的是都有两个头 FU indicator 和 FU header，大小都是一个字节。

```shell
  +---------------+
  |0|1|2|3|4|5|6|7|
  +-+-+-+-+-+-+-+-+
  |F|NRI|  Type   |
  +---------------+
   FU indicator format

  +---------------+
  |0|1|2|3|4|5|6|7|
  +-+-+-+-+-+-+-+-+
  |S|E|R|  Type   |
  +---------------+
   FU header format
```

分片单元不能用于传输一个分片，因为不能同时在一个 FU 头里面设置开始和结束标志。

# 4. SDP参数

下面描述了如何在 SDP 中表示一个 H.264 流:

. "m=" 行中的媒体名必须是 "video"
. "a=rtpmap" 行中的编码名称必须是 "H264".
. "a=rtpmap" 行中的时钟频率必须是 90000.
. 其他参数都包括在 "a=fmtp" 行中.

如:

```Shell
m=video 49170 RTP/AVP 98
a=rtpmap:98 H264/90000
a=fmtp:98 profile-level-id=42A01E; sprop-parameter-sets=Z0IACpZTBYmI,aMljiA==
```

## 4.1 packetization-mode
表示支持的封包模式.
当 packetization-mode 的值为 0 时或不存在时, 必须使用单一 NALU 单元模式.
当 packetization-mode 的值为 1 时必须使用非交错(non-interleaved)封包模式.
当 packetization-mode 的值为 2 时必须使用交错(interleaved)封包模式.
这个参数不可以取其他的值.

## 4.2 sprop-parameter-sets
这个参数可以用于传输 H.264 的序列参数集和图像参数 NAL 单元. 这个参数的值采用 Base64 进行编码. 不同的参数集间用","号隔开.

## 4.3 profile-level-id
这个参数用于指示 H.264 流的 profile 类型和级别. 由 Base16(十六进制) 表示的 3 个字节. 第一个字节表示 H.264 的 Profile 类型, 第三个字节表示 H.264 的 Profile 级别:

## 4.4 max-mbps
这个参数的值是一个整型, 指出了每一秒最大的宏块处理速度.

# 其他

## I、P、B帧介绍

**I帧：**帧内编码帧 ，I帧表示关键帧，你可以理解为这一帧画面的完整保留；解码时只需要本帧数据就可以完成（因为包含完整画面）。I帧特点如下：
1.它是一个全帧压缩编码帧。它将全帧图像信息进行JPEG压缩编码及传输;
2.解码时仅用I帧的数据就可重构完整图像;
3.I帧描述了图像背景和运动主体的详情;
4.I帧不需要参考其他画面而生成;
5.I帧是P帧和B帧的参考帧(其质量直接影响到同组中以后各帧的质量);
6.I帧是帧组GOP的基础帧(第一帧),在一组中只有一个I帧;
7.I帧不需要考虑运动矢量;
8.I帧所占数据的信息量比较大。

**P帧：**前向预测编码帧。P帧表示的是这一帧跟之前的一个关键帧（或P帧）的差别，解码时需要用之前缓存的画面叠加上本帧定义的差别，生成最终画面。（也就是差别帧，P帧没有完整画面数据，只有与前一帧的画面差别的数据）

**P帧的预测与重构：**P帧是以I帧为参考帧,在I帧中找出P帧“某点”的预测值和运动矢量,取预测差值和运动矢量一起传送。在接收端根据运动矢量从I帧中找出P帧“某点”的预测值并与差值相加以得到P帧“某点”样值,从而可得到完整的P帧。
**P帧特点:**
1.P帧是I帧后面相隔1~2帧的编码帧;
2.P帧采用运动补偿的方法传送它与前面的I或P帧的差值及运动矢量(预测误差);
3.解码时必须将I帧中的预测值与预测误差求和后才能重构完整的P帧图像;
4.P帧属于前向预测的帧间编码。它只参考前面最靠近它的I帧或P帧;
5.P帧可以是其后面P帧的参考帧,也可以是其前后的B帧的参考帧;
6.由于P帧是参考帧,它可能造成解码错误的扩散;
7.由于是差值传送,P帧的压缩比较高。

**B帧：**双向预测内插编码帧。B帧是双向差别帧，也就是B帧记录的是本帧与前后帧的差别（具体比较复杂，有4种情况，但我这样说简单些），换言之，要解码B帧，不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的与本帧数据的叠加取得最终的画面。B帧压缩率高，但是解码时CPU会比较累。

**B帧的预测与重构**
B帧以前面的I或P帧和后面的P帧为参考帧,“找出”B帧“某点”的预测值和两个运动矢量,并取预测差值和运动矢量传送。接收端根据运动矢量在两个参考帧中“找出(算出)”预测值并与差值求和,得到B帧“某点”样值,从而可得到完整的B帧。
**B帧特点：**
1.B帧是由前面的I或P帧和后面的P帧来进行预测的;
2.B帧传送的是它与前面的I或P帧和后面的P帧之间的预测误差及运动矢量;
3.B帧是双向预测编码帧;
4.B帧压缩比最高,因为它只反映丙参考帧间运动主体的变化情况,预测比较准确;
5.B帧不是参考帧,不会造成解码错误的扩散。
